{% extends 'base.html' %}

{% block content %}
<div class="p-6">
    <h1 class="text-2xl font-bold mb-6">Service Management</h1>

    <!-- Filters and Actions -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
        <div class="flex gap-2 w-full md:w-2/3">
            <input type="text" id="search" class="border border-gray-300 rounded px-4 py-2 w-1/3" placeholder="Search services...">
            <select id="category_filter" class="border border-gray-300 rounded px-4 py-2 w-1/3">
                <option value="">All Categories</option>
            </select>
            <select id="subcategory_filter" class="border border-gray-300 rounded px-4 py-2 w-1/3">
                <option value="">All Sub-Categories</option>
            </select>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'manage_groups' %}" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded">
                Manage Groups
            </a>
            <a href="{% url 'add_service' %}">
            <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Add Services</button>
        </a>
        </div>
    </div>

    <!-- Services Table -->
    <div class="overflow-x-auto bg-white rounded shadow">
        <table class="min-w-full text-sm text-left">
            <thead class="bg-gray-100 border-b">
                <tr>
                    <th class="px-4 py-2">SN</th>
                    <th class="px-4 py-2">Name</th>
                    <th class="px-4 py-2">Category / Sub-Category</th>
                    <th class="px-4 py-2">Price</th>
                    <th class="px-4 py-2">Description</th>
                    <th class="px-4 py-2">Actions</th>
                </tr>
            </thead>
            <tbody id="services_table" class="divide-y">
                <!-- Services data will be injected here -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="mt-4 flex justify-center gap-2" id="pagination">
        <!-- Pagination buttons will be injected here -->
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    axios.defaults.headers.common['X-CSRFToken'] = document.querySelector('[name=csrf-token]').content;
</script>
<script>
    let currentPage = 1;

    function fetchServices(page = 1, search = '', category = '', subCategory = '') {
        axios.get(`/api/services/?page=${page}&search=${search}&category=${category}&sub_category=${subCategory}`)
            .then(response => {
                const services = response.data.results;
                const tbody = document.getElementById('services_table');
                tbody.innerHTML = '';

                services.forEach((service, index) => {
                    tbody.innerHTML += `
                        <tr>
                            <td class="px-4 py-2">${index + 1}</td>
                            <td class="px-4 py-2">${service.name}</td>
                            <td class="px-4 py-2">
                                ${service.category?.category || 'N/A'} / ${service.sub_category?.category || 'N/A'}
                            </td>
                            <td class="px-4 py-2">Nrs. ${service.price}</td>
                            <td class="px-4 py-2 truncate max-w-xs">${service.description || ''}</td>
                            <td class="px-4 py-2 space-x-2">
                                <button class="text-blue-500 hover:underline" onclick="editService(${service.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-500 hover:underline" onclick="deleteService(${service.id})">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                renderPagination(response.data.count, page);
            })
            .catch(error => {
                console.error('Failed to fetch services:', error);
            });
    }

    function renderPagination(totalItems, currentPage) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        const totalPages = Math.ceil(totalItems / 10);

        for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `
                <button class="px-3 py-1 rounded ${i === currentPage ? 'bg-indigo-500 text-white' : 'bg-gray-200'}"
                        onclick="updateServiceView(${i})">
                    ${i}
                </button>
            `;
        }
    }

    function updateServiceView(page = 1) {
        const search = document.getElementById('search').value;
        const category = document.getElementById('category_filter').value;
        const subCategory = document.getElementById('subcategory_filter').value;
        currentPage = page;
        fetchServices(page, search, category, subCategory);
    }

    function editService(id) {
        // Redirect to edit page - change the URL as per your routing
        window.location.href = `/services/edit/${id}/`;
    }

    function deleteService(id) {
        if (confirm("Are you sure you want to delete this service?")) {
            axios.delete(`/api/services/${id}/`)
                .then(() => {
                    alert("Service deleted successfully");
                    updateServiceView(currentPage);
                })
                .catch(error => {
                    console.error("Failed to delete service:", error);
                    alert("Error deleting service");
                });
        }
    }

    // Event listeners
    document.getElementById('search').addEventListener('input', () => updateServiceView(1));
    document.getElementById('category_filter').addEventListener('change', () => updateServiceView(1));
    document.getElementById('subcategory_filter').addEventListener('change', () => updateServiceView(1));

    // Load initial data
    document.addEventListener('DOMContentLoaded', function () {
        updateServiceView();

        // Load categories
        axios.get('/api/categories/')
            .then(res => {
                const categorySelect = document.getElementById('category_filter');
                res.data.forEach(cat => {
                    categorySelect.innerHTML += `<option value="${cat.id}">${cat.category}</option>`;
                });
            });

        // Load sub-categories
        axios.get('/api/subcategories/')
            .then(res => {
                const subCategorySelect = document.getElementById('subcategory_filter');
                res.data.forEach(sub => {
                    subCategorySelect.innerHTML += `<option value="${sub.id}">${sub.category}</option>`;
                });
            });
    });
    function deleteCategory(id) {
        if (confirm("Are you sure you want to delete this category?")) {
            axios.delete(`/api/services/${id}/`)
                .then(() => {
                    alert("Services deleted successfully");
                    fetchGroups();
                })
                .catch(error => {
                    console.error("Error deleting category:", error);
                    alert("Failed to delete category.");
                });
        }
    }

    function editCategory(id, currentName) {
        const newName = prompt("Enter new category name:", currentName);
        if (newName && newName !== currentName) {
            axios.patch(`/api/services/${id}/`, { category: newName })
                .then(() => {
                    alert("Services updated successfully");
                    fetchGroups();
                })
                .catch(error => {
                    console.error("Error updating category:", error);
                    alert("Failed to update category.");
                });
        }
    }

</script>
{% endblock %}
